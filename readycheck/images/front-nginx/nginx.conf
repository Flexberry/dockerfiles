worker_processes auto;

error_log stderr crit;

events {
    use epoll;
    multi_accept on;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    access_log /dev/stdout;

    sendfile on;
    tcp_nopush on;

    keepalive_timeout 100;

    gzip on;
    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;

    open_file_cache max=200000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;

    #https://stackoverflow.com/questions/48964429/net-core-behind-nginx-returns-502-bad-gateway-after-authentication-by-identitys
    proxy_buffer_size   128k;
    proxy_buffers   4 256k;
    proxy_busy_buffers_size   256k;
    large_client_header_buffers 4 16k;

    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name _;
        return 301 https://$host$request_uri;
    }

    server {
       client_max_body_size 100m;
       listen       443 ssl;
       server_name  dms.zspk.perm.ru;

       ssl_certificate      dms.zspk.perm.ru.crt;
       ssl_certificate_key  dms.zspk.perm.ru.key;

       ssl_session_cache    shared:SSL:10m;
       ssl_session_timeout  10m;

       ssl_ciphers  HIGH:!aNULL:!MD5;
       ssl_prefer_server_ciphers  on;

       proxy_connect_timeout 600;
       proxy_send_timeout 600;
       proxy_read_timeout 600;
       send_timeout 600;

       location /check-session/
       {
            if ($http_cookie !~ 'ZS.DMS.App.Cookie') {
                return 401;
            }
            return 200;
       }

      #Полноценная корректная работа на тесте аналитиков предполагает перевод всех location на TestAnalyst.
	    #Для работы чисто с фронтендом не обязательно локально поднимать остальные части системы.
	    #Локальный запуск бекенда требует также локального запуска IdentityService. При этом не забыть переключить локально /auth/ /odata/ /api/ /reportapi/.

       location / {
            proxy_pass http://localhost:4202;
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection keep-alive;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
       }

       location /auth/
       {
            proxy_pass http://IdentityServer;
            #proxy_pass http://localhost:5000;
            #proxy_pass http://172.17.3.30:10080; #TestAnalyst
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection keep-alive;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
       }

       location /webdav/
       {
            proxy_pass http://WebDavServer/webdav/;
            #proxy_pass http://localhost:8090;
            #proxy_pass http://172.17.3.30:9400/webdav/; #TestAnalyst
            proxy_set_header Host $host;
            proxy_http_version 1.1;
            proxy_set_header   Upgrade $http_upgrade;
            proxy_set_header   Connection keep-alive;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            #https://stackoverflow.com/questions/48964429/net-core-behind-nginx-returns-502-bad-gateway-after-authentication-by-identitys
            fastcgi_buffers 16 16k;
            fastcgi_buffer_size 32k;
       }

       location /odata/
       {
            proxy_pass http://dms-back/odata/;
            #proxy_pass http://localhost:7700;
            #proxy_pass http://172.17.3.30:8183/odata/; #TestAnalyst
       }

       location /api/
       {
            proxy_pass http://dms-back/api/;
            #proxy_pass http://localhost:7700;
            #proxy_pass http://172.17.3.30:8183/api/; #TestAnalyst
       }

       location /reportapi/
       {
            proxy_pass http://dms-back/reportapi/;
            ##proxy_pass  http://localhost:7700/reportapi/;
            #proxy_pass http://172.17.3.30:8183/reportapi/; #TestAnalyst
       }

       location /bpm/odata/
       {
            proxy_pass http://bpm-webapi/odata/;
            #proxy_pass http://localhost:6337;
		        #proxy_pass http://172.17.3.30:6337/odata/; #TestAnalyst
       }

       location /ffapi/
       {
            proxy_pass http://bpm-webapi/ffapi/;
            #proxy_pass http://localhost:6337;
		        #proxy_pass http://172.17.3.30:6337/ffapi/; #TestAnalyst
       }

       location /activityservice/
       {
            proxy_pass http://bpm-activityservice/activityservice/;
            #proxy_pass http://localhost:50449;
		        #proxy_pass http://172.17.3.30:8182/activityservice/; #TestAnalyst
       }

       location /templatelibrary/
       {
            proxy_pass http://template-collection/;
            #proxy_pass http://localhost:56389/;
		        #proxy_pass http://172.17.3.30:56389/; #TestAnalyst
       }

	     location /agendas/
       {
            proxy_pass  http://10.130.5.79:6500/webapi/;
            #proxy_pass  http://localhost:6505;
		        #proxy_pass  http://10.130.5.107:6500/webapi/; #TestAnalyst
       }

    }
}
