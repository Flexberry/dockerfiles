# readycheck - Описание скрипта readycheck и способы его использования в сервисах docker-compose

Данный скрипт был написан для решения задачи  [Запуск докер-сервисов из стека сервисов в заданном порядке](https://gitlab.flexberry-foundation.ru/infrastructure/public/-/issues/225061).

## Общее описание

Скрипт обеспечивает ожидание появления доступа к заданным URL. После того как доступ ко всем URL появился скрипт прекращает свою работу и заканчивается с кодом завершний 0.

Скрипт требует наличия программы curl

Экспортируемые переменные:

* `READYCHECK_URLS` - Список `URLS` через пробел

    Format `URL`:
    <pre>
    IP:PORT
    SERVICENAME:PORT
    http://IP:PORT/[...]
    HTTP://IP:PORT/[...]
    http://SERVICENAME:PORT/[...]
    HTTP://SERVICENAME:PORT/[...]
    https://IP:PORT/[...]
    HTTPS://IP:PORT/[...]
    https://SERVICENAME:PORT/[...]
    HTTPS://SERVICENAME:PORT/[...]
    </pre>
    Согласно предоставленному списку URL он проверяет наличие указанных открытых портов:

    - протоколы `http`, `https` (форматы `http://IP:PORT/[...]`, `HTTP://IP:PORT/[...])`, `http://SERVICENAME:PORT/[...]`, `HTTP://SERVICENAME:PORT/`, `https://IP:PORT/[...]`, `HTTPS://IP:PORT/[...]`, `https://SERVICENAME:PORT/[...]`, `HTTPS://SERVICENAME:PORT/[...]`  :

        Для протокола `http` и `https`  проверяется наличие в первой строке ответа:
        <pre>
        HTTP/N CODE
        </pre>
        - Если имя протокола в `URL` написно заглавными буквми (`HTTP`, `HTTPS`) код завершения запроса  (`CODE`) должен быть `< 400`
        - Если прописными (`http`, `https`) - код завершения запроса не проверяется

    - остальные протоколы (формат `SERVICENAME:PORT`, `IP:PORT`)

        Для остальных протоколов (psql, ...) проверяется только наличие готового отвечающего порта.

    Если порт недоступен или код завершения неверный сканирование дальнейших `URL` в списке прекращается и через `READYCHECK_TIMEOUT` производится тестирование указанных `URLs` с начала.

    Пример:
        <pre>
        READYCHECK_URLS="postgres:5432 x.x.x.x:55555 http://front-nginx/ HTTPS://front-nginx/"
        </pre>

* READYCHECK_TIMEOUT - Таймаут между проверками списка `URL`S - по умолчанию `5` секунд

При сборке образа скрипт необходимо:

* скопиовать в среду образа командой:
<pre>
COPY readycheck /bin/
</pre>

* вставить в инстркцию `CMD` `Dockerfile` до вызова основной команды:
<pre>
CMD readycheck && &lt;ОСНОВНАЯ_КОМАНДА_ОБРАЗА&gt;
</pre>

Посмотреть вызов основной команды базового образа (инструкция `FROM` в `Dockerfile`) можно командами:
<pre>
docker inspect &lt;имя_образа&gt; | jq '.[].Config.Cmd'
</pre>

Например:
<pre> e/dms-
$ docker inspect nginx   | jq '.[].Config.Cmd'
[
  "nginx",
  "-g",
  "daemon off;"
]

</pre>



## Результаты

В результате применения скрипта:

* Обеспечивается синхронизация запуска сервисов. Скрипт `readycheck` дожидается подъема всех зависимых сервисов и определения из DNS-имен в DNS_сервере стека сервисов. В момент окончания скрипта `DNS` всех зависимх сервисов определен и файлах конфигурации сервисов в `URL` можно (и нужно) использовать имена сериисов.

* Файлы описания сервсиов `docker-compose.yml`, `docker-swarm.yml` становятся более универсальным. Необходимы минимальные изменения при их переносе в другие среды развертывания.

* Повышена безопасность решения за счет отсутствия проброса внутренних портов наружу.

