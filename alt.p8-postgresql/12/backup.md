# Режимы бекапа

Образ поддеживает два режима бекапа:
- Бекап с удаленного postgres-сервера средствами DUMP/RESTORE. Данный режим включается пи наличии переменной `BACKUP_RESTORE`.
- Бекап из архива WAL-G. Данный режим включается при наличии переменной `BACKUP_WALG`.

Переменные `BACKUP_RESTORE`, `BACKUP_WALG` содержат уникальный идентификатор
в формат YYYY-mm-dd** **HH:MM:SS.
Где:
- `YYYY` - год;
- `mm` - месяц;
- `dd` - день;
- `HH` - час;
- `MM` - минута;
- `SS` - секунда.

Между месяцем и часом **должен** присутствовать пробел.
Например `2020-03-15 09:52:54`.

Цель идентификатора: 
- Для режима `WAL-G` задает время на которое восстанавливать базу данных (параметр recovery_target_time). При восстановлении последнего состояния базы данное время должно быть заведомо больше или равно текущему.
- Исключить повторное восстановление базы данных при перезагрузке сервиса базы данных. Если идентификатор совпадает с предыдущим восстановление базы данных не производится.

## Переменные режима восстановления базы данных по протоколу DUMP/RESTORE

- **`BACKUP_RESTORE='уникальный идентификтор`** - инициирует бекап DUMP/RESTORE;
- **`RESTORE_HOST`** - IP-адрес или домен сервера `postgresql` с которого производится бекап;
- `RESTORE_PORT` - порт сервера `postgresql` (по умолчанию 5432);
- `RESTORE_USER` - имя пользователя `postgresql` от имени которого поизводится бекап (по умолчанию `postgres`);
- **`RESTORE_PASSWORD`** - пароль пользователя `postgresql` от имени которого производится бекап. 

**Жирным шрифтом** выделены обязательые переменные.

На стороне сервера на который производится бекап запускается команда:
```
export PGPASSWORD='...';
pg_dumpall -h ... -p ... -U ... --clean --if-exists | psql -U postgres
```

## Переменные режима архивирования базы данных по протоколу WALG

Переменные режима `WALG` описаны в разделе
[Бекапирования системой wal-g](walg_backup.md). 
На момент запуска восстановления архив `WALG` уже должен существовать.



