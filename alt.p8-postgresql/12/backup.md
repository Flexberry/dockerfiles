# Режимы бекапа

Образ поддеживает два режима бекапа:
- Бекап с удаленного postgres-сервера средствами DUMP/RESTORE. Данный режим включается пи наличии переменной `BACKUP_RESTORE`.
- Бекап из архива WAL-G. Данный режим включается при наличии переменной `BACKUP_WALG`.

Переменные `BACKUP_RESTORE`, `BACKUP_WALG` содержат уникальный идентификатор
в формат YYYY-mm-dd**T**HH:MM:SS**Z**.
Где:
- `YYYY` - год;
- `mm` - месяц;
- `dd` - день;
- `HH` - час;
- `MM` - минута;
- `SS` - секунда.
- **T**, **Z** - символы.

Например `2020-03-15T09:52:54Z`.

Цель идентификатора: 
- опеделить время на которое восстанавливать базу данных (при восстановлении последнего состояния базы данное вемя должно быть заведомо больше или азно текущему);
- исключить повторное восстановление базы данных при перезагрузке сервиса базы данных.

Если идентификатор совпадает с предыдущим восстановление базы данных не производится.

## Переменные режима восстановления базы данных по протоколу DUMP/RESTORE

- **`BACKUP_RESTORE='уникальный идентификтор`** - инициирует бекап DUMP/RESTORE;
- **`RESTORE_HOST`** - IP-адрес или домен сервера `postgresql` с которого производится бекап;
- `RESTORE_PORT` - порт сервера `postgresql` (по умолчанию 5432);
- `RESTORE_USER` - имя пользователя `postgresql` от имени которого поизводится бекап (по умолчанию `postgres`);
- **`RESTORE_PASSWORD`** - пароль пользователя `postgresql` от имени которого производится бекап. 

**Жирным шрифтом** выделены обязательые переменные.

На стороне сервера на который производится бекап запускается команда:
```
export PGPASSWORD='...';
pg_dumpall -h ... -p ... -U ... --clean --if-exists | psql -U postgres
```

## Переменные режима восстановления базы данных по протоколу WALG

Переменные режима `WALG` описаны в разделе
[Бекапирования системой wal-g](walg_backup.md). 
На момент запуса восстановления архив `WALG` уже должен существовать.

