## Предложения по разрешению текущих проблем автосборки

К сожалению из за того, что задача, запущенная после добавления на github.com соответсвующего шаблону тега 
может неопределенно долго (до нескольких часов) находится в состоянии `PENDING` довольно трудно провести отладку новых образов и скриптов на сервисе автоматической автосборки (тестирования).

На локальном компьютере данные операции производятся в течении нескольких минут.

В связи с этим предлагается создание набора скриптов, позволяющих выполнить сборку и тестирование образов по шаблонам и протоколам 
описанного выше сервиса.

### Набор скриптов

Основные скрипты:

- [testAutobuild.sh](testAutobuild.sh) - скрипт сборку образа из Dockerfile и выполнение тестовых скриптов (`*.test.yml`) локального git-репозитория.
  При успешной сборке и тестировании производится:
  * если необходимо `commit` и  в `git-репозиторий` 
  * добавляется новый или указанный `git-tag';
  * при утвердительном ответе выполняет скрипты hooks/pre_push (стандартно создание алиасов образа) и hooks/post_push (стандартно передаче алиасов в `hub.docker.com` репозиторий);
  * производится передача нового `commit`'а и `tag`'а на `github.com` 

- [deletetags.sh](deletetags.sh) - удаляет перечисленные теги из локального и удаленного github.com репозитория.
>Скрипт не удаляет собранные согласно указанным тегам образы на `hub.docker.com`. Возможно  в следующие релизы стоит включить этот функуионал.

- [rebuildByTags.sh](rebuildByTags.sh) - обновляет перечисленные теги в локальном и удаленном репозитории что приводит к повторной автоматической сборке образа по указанным тегам 
>Скрипт не производит переключение (`checkout`) на теги перед обновлением. В случае необходимости это надо сделать самостоятельно. 

- [hookFunctions.sh](hookFunctions.sh) - набор shell-фукций используемых в shell-скриптах [hooks/pre_push](alt.p8-nginx/hooks/pre_push), [hooks/post_push](/alt.p8-nginx/hooks/post_push) для установки алиасов образа(`setAliases()`) и размещения образов в репозитории (`pushAliases()`)

#### Скрипт локальной сборки и тестирования образов `[testAutobuild.sh](testAutobuild.sh)`

Скрипт автосборки образов по протоколам https://cloud.docker.com/
обеспечивает сборку и тестирование образов на основе локального  git-репозитория

Формат вызова:
```
testAutobuild.sh <каталог_репозитория_образа> [версия_сборки]
```

Скрипт запускается из родительского каталога локального git-репозитория
Каталог репозитория сборки включает имя git-репозитория (первый поддиректорий) и тропу (последующие поддиректории) до каталога, где находится `Dockerfile` (напроимер `dockerfiles/pentaho/official/`)
и кроме основных файлов и каталогов для docker-сборки должен включать в себя файл `.autobuid` формата:
```
IMAGE=<имя_образа_без_префикса_flexberry/>
VERSION=<версия_сервиса(если_есть)>
```
 
При отсутствии параметра `версия_сборки` формируется следующая PATCH'евая (последнее число в триаде `x.y.z`) версия образа
и сборка производится в текущей ветке репозитория (разрвботчик имеет возможность указать другую МИНОРНУЮ или МАЖОРНУЮ версию сборки)

При наличии параметра `версия_сборки` перед сборкой производится переключение на указанный git-тег
(формируется из `IMAGE`, `VERSION` и  `версия_сборки`).

После сборки при наличии файлов `*test.yml` производится тестирование собранного образа согласно этим файлам.
При успешном тестировании производится:

- линковка собранного образа со всеми его алиасами (latest, минорной, мажорной версией)
  ```
  docker tag `<собранный_образ> <алиас_образа>
  ```
  
  Если привызове скрипта не был указан второй параметр `версия_сборки`, то :
  
- производится commit и обновление репозитория:
  ```
  git commit -a; git pull; git push
  ```
- сформированный git-тег добавляется в локальный git-репозиторий и удаленный github.com репозиторий:
  ```
  git tag <git-tag>; git push --tags
  ```
 По указанным параметрам выводятся параметры конфигурации автосборки образа на `https://cloud.docker.com/`:
```
Source Type: Tag 
Source: ...
Docker Tag: ...
Dockerfile location: Dockerfile
Build Context: ...
```
  
Если на `https://cloud.docker.com/` была настроена автосборка образа по указанномк шаблону,
то после передачи нового `git-тега` на `github.com` запускается автосборка, тестирование и размещение новой версии образа. 

#### Файл `hookFunctions.sh`  shell-функций используемых в shell-скриптах `hooks/pre_push`, `hooks/post_push`

Данный shel-файл содержит набор следующих функий:

- `setListImageAliases()` - вспомогательная функция на основе имени образа `IMAGE_NAME` с полным тегом формирует список алиасных образов `ALIASES_NAMES` с подтегами: `minorImage`, `majorImage`, `versionImage`.  В качестве параметров функции могут передаваться дополнительные теги. 
>Имя версии `:latest` образа не формируется. При необходмости тег `latest` указывается в качестве параметра. 

- `setAliases()` - создание алиасных образов (`docker tag ...`).  В качестве параметров функции могут передаваться дополнительные теги.
>Версия `latest` образа не формируется. При необходмости тег `latest` указывается в качестве параметра. 

- `pushAliases()` - создание алиасных образов (`docker push ...`).  В качестве параметров функции могут передаваться дополнительные теги.
>Версия `latest` образа не передается. При необходмости тег `latest` указывается в качестве параметра. 
